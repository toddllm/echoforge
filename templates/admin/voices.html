{% extends "admin/layout.html" %}

{% block title %}Voices - EchoForge Admin{% endblock %}

{% block page_title %}Voice Management{% endblock %}

{% block content_actions %}
<div class="action-buttons">
    <button id="add-voice-btn" class="button primary-button">Add New Voice</button>
    <button id="scan-voices-btn" class="button secondary-button">Scan for Voices</button>
</div>
{% endblock %}

{% block content %}
<div class="voice-management">
    <div class="alert alert-info alert-dismissible fade show" role="alert">
        <strong>Note:</strong> The server is currently running on port 8767. Make sure you're accessing the admin panel at <strong>http://[server-address]:8767/admin</strong>.
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    
    <div class="voice-filters">
        <div class="search-container">
            <input type="text" id="voice-search" placeholder="Search voices..." class="search-box">
            <button id="search-btn" class="search-button">
                <i class="fas fa-search"></i>
            </button>
        </div>
        <div class="filter-controls">
            <select id="voice-gender-filter" class="filter-select">
                <option value="all">All Genders</option>
                <option value="male">Male</option>
                <option value="female">Female</option>
                <option value="neutral">Neutral</option>
            </select>
            <select id="voice-style-filter" class="filter-select">
                <option value="all">All Styles</option>
                <option value="natural">Natural</option>
                <option value="excited">Excited</option>
                <option value="calm">Calm</option>
                <option value="serious">Serious</option>
                <option value="other">Other</option>
            </select>
            <button id="filter-reset-btn" class="filter-reset-button">
                <i class="fas fa-times"></i> Reset
            </button>
        </div>
    </div>
    
    <div class="voice-status-section">
        <div class="status-cards">
            <div class="status-card">
                <h3>Voice Statistics</h3>
                <div class="card-content stats-grid">
                    <div class="stat-item">
                        <div class="stat-value">{{ voice_stats.total }}</div>
                        <div class="stat-label">Total Voices</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">{{ voice_stats.male }}</div>
                        <div class="stat-label">Male</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">{{ voice_stats.female }}</div>
                        <div class="stat-label">Female</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">{{ voice_stats.neutral }}</div>
                        <div class="stat-label">Neutral</div>
                    </div>
                </div>
            </div>
            <div class="status-card">
                <h3>Model Information</h3>
                <div class="card-content">
                    <div class="model-info">
                        <div class="model-name">{{ model_info.name }}</div>
                        <div class="model-details">{{ model_info.total_voices }} voices available</div>
                    </div>
                    <div class="model-status {{ 'active' if model_info.is_loaded else 'inactive' }}">
                        <span class="status-dot"></span> {{ 'Active' if model_info.is_loaded else 'Inactive' }}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="voices-table-container">
        <table class="voices-table">
            <thead>
                <tr>
                    <th class="sortable" data-sort="id">ID <i class="fas fa-sort"></i></th>
                    <th class="sortable" data-sort="name">Name <i class="fas fa-sort"></i></th>
                    <th class="sortable" data-sort="gender">Gender <i class="fas fa-sort"></i></th>
                    <th class="sortable" data-sort="style">Style <i class="fas fa-sort"></i></th>
                    <th class="sortable" data-sort="language">Language <i class="fas fa-sort"></i></th>
                    <th>Sample</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for voice in voices %}
                <tr data-voice-id="{{ voice.id }}">
                    <td>{{ voice.id }}</td>
                    <td>
                        <div class="voice-name-cell">
                            <img src="{{ voice.avatar_url }}" alt="{{ voice.name }}" class="voice-avatar">
                            <span class="voice-name">{{ voice.name }}</span>
                        </div>
                    </td>
                    <td>{{ voice.gender }}</td>
                    <td>{{ voice.style }}</td>
                    <td>{{ voice.language }}</td>
                    <td>
                        <div class="audio-sample">
                            <audio src="{{ voice.sample_url }}" class="sample-player" preload="none"></audio>
                            <button class="play-button">
                                <i class="fas fa-play"></i>
                            </button>
                        </div>
                    </td>
                    <td>
                        <div class="action-menu">
                            <button class="action-button">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <div class="action-dropdown">
                                <a href="#" class="action-item edit-voice" data-voice-id="{{ voice.id }}">
                                    <i class="fas fa-edit"></i> Edit
                                </a>
                                <a href="#" class="action-item view-voice" data-voice-id="{{ voice.id }}">
                                    <i class="fas fa-eye"></i> View Details
                                </a>
                                <a href="#" class="action-item test-voice" data-voice-id="{{ voice.id }}">
                                    <i class="fas fa-microphone"></i> Test Voice
                                </a>
                                <a href="#" class="action-item delete-voice" data-voice-id="{{ voice.id }}">
                                    <i class="fas fa-trash-alt"></i> Delete
                                </a>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <div class="pagination">
        <div class="pagination-info">
            Showing {{ pagination.start }}-{{ pagination.end }} of {{ pagination.total }} voices
        </div>
        <div class="pagination-controls">
            <button class="pagination-button" {% if not pagination.has_prev %}disabled{% endif %}>
                <i class="fas fa-angle-double-left"></i>
            </button>
            <button class="pagination-button" {% if not pagination.has_prev %}disabled{% endif %}>
                <i class="fas fa-angle-left"></i>
            </button>
            <div class="pagination-pages">
                {% for page in pagination.pages %}
                <button class="pagination-page {% if page == pagination.current %}active{% endif %}">
                    {{ page }}
                </button>
                {% endfor %}
            </div>
            <button class="pagination-button" {% if not pagination.has_next %}disabled{% endif %}>
                <i class="fas fa-angle-right"></i>
            </button>
            <button class="pagination-button" {% if not pagination.has_next %}disabled{% endif %}>
                <i class="fas fa-angle-double-right"></i>
            </button>
        </div>
        <div class="pagination-size">
            <label for="pagination-size-select">Show:</label>
            <select id="pagination-size-select" class="pagination-size-select">
                <option value="10" {% if pagination.per_page == 10 %}selected{% endif %}>10</option>
                <option value="25" {% if pagination.per_page == 25 %}selected{% endif %}>25</option>
                <option value="50" {% if pagination.per_page == 50 %}selected{% endif %}>50</option>
                <option value="100" {% if pagination.per_page == 100 %}selected{% endif %}>100</option>
            </select>
        </div>
    </div>
</div>

<!-- Voice Details Modal -->
<div id="voice-details-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Voice Details</h2>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <div class="voice-detail-container">
                <div class="voice-detail-header">
                    <div class="voice-avatar-large">
                        <img id="detail-avatar" src="" alt="Voice Avatar">
                    </div>
                    <div class="voice-detail-info">
                        <h1 id="detail-name"></h1>
                        <div class="voice-detail-metadata">
                            <div class="detail-tag" id="detail-gender"></div>
                            <div class="detail-tag" id="detail-style"></div>
                            <div class="detail-tag" id="detail-language"></div>
                        </div>
                        <div class="voice-id-display">
                            Voice ID: <span id="detail-id"></span>
                        </div>
                    </div>
                </div>
                
                <div class="voice-detail-description">
                    <h3>Description</h3>
                    <p id="detail-description"></p>
                </div>
                
                <div class="voice-detail-section">
                    <h3>Voice Sample</h3>
                    <div class="voice-sample-player">
                        <audio id="detail-audio" controls></audio>
                    </div>
                </div>
                
                <div class="voice-detail-section">
                    <h3>Technical Information</h3>
                    <div class="details-grid">
                        <div class="detail-item">
                            <span class="detail-label">Sample Rate:</span>
                            <span class="detail-value" id="detail-sample-rate"></span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Format:</span>
                            <span class="detail-value" id="detail-format"></span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Created:</span>
                            <span class="detail-value" id="detail-created"></span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Last Modified:</span>
                            <span class="detail-value" id="detail-modified"></span>
                        </div>
                    </div>
                </div>
                
                <div class="voice-detail-section">
                    <h3>Usage Statistics</h3>
                    <div class="details-grid">
                        <div class="detail-item">
                            <span class="detail-label">Times Used:</span>
                            <span class="detail-value" id="detail-usage-count"></span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Average Generation Time:</span>
                            <span class="detail-value" id="detail-avg-time"></span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Last Used:</span>
                            <span class="detail-value" id="detail-last-used"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button id="close-detail-btn" class="button secondary-button">Close</button>
            <div class="detail-actions">
                <button id="edit-detail-btn" class="button primary-button">Edit Voice</button>
                <button id="test-detail-btn" class="button secondary-button">Test Voice</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Voice Modal -->
<div id="edit-voice-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="edit-modal-title">Edit Voice</h2>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <form id="voice-form" class="voice-form">
                <input type="hidden" id="voice-id" name="id" value="">
                
                <div class="form-section">
                    <h3>Basic Information</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="voice-name">Name</label>
                            <input type="text" id="voice-name" name="name" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="voice-gender">Gender</label>
                            <select id="voice-gender" name="gender" class="form-control">
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="neutral">Neutral</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="voice-style">Style</label>
                            <select id="voice-style" name="style" class="form-control">
                                <option value="natural">Natural</option>
                                <option value="excited">Excited</option>
                                <option value="calm">Calm</option>
                                <option value="serious">Serious</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        <div class="form-group" id="custom-style-group" style="display: none;">
                            <label for="voice-custom-style">Custom Style</label>
                            <input type="text" id="voice-custom-style" name="custom_style" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="voice-language">Language</label>
                            <select id="voice-language" name="language" class="form-control">
                                <option value="en-US">English (US)</option>
                                <option value="en-GB">English (UK)</option>
                                <option value="es-ES">Spanish</option>
                                <option value="fr-FR">French</option>
                                <option value="de-DE">German</option>
                                <option value="it-IT">Italian</option>
                                <option value="ja-JP">Japanese</option>
                                <option value="ko-KR">Korean</option>
                                <option value="zh-CN">Chinese (Simplified)</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="voice-description">Description</label>
                        <textarea id="voice-description" name="description" rows="3" class="form-control"></textarea>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>Voice Avatar</h3>
                    <div class="avatar-selection">
                        <div class="current-avatar">
                            <img id="avatar-preview" src="/static/images/default_avatar.png" alt="Voice Avatar">
                        </div>
                        <div class="avatar-options">
                            <div class="form-group">
                                <label for="avatar-type">Avatar Type</label>
                                <select id="avatar-type" name="avatar_type" class="form-control">
                                    <option value="generated">Auto-Generated</option>
                                    <option value="upload">Upload Image</option>
                                    <option value="url">Image URL</option>
                                </select>
                            </div>
                            <div id="avatar-upload-group" style="display: none;">
                                <div class="form-group">
                                    <label for="avatar-upload">Upload Avatar</label>
                                    <input type="file" id="avatar-upload" name="avatar_file" class="form-control-file" accept="image/*">
                                </div>
                            </div>
                            <div id="avatar-url-group" style="display: none;">
                                <div class="form-group">
                                    <label for="avatar-url">Avatar URL</label>
                                    <input type="url" id="avatar-url" name="avatar_url" class="form-control" placeholder="https://example.com/image.jpg">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>Voice Sample</h3>
                    <div class="form-group">
                        <label for="sample-type">Sample Type</label>
                        <select id="sample-type" name="sample_type" class="form-control">
                            <option value="generate">Generate New Sample</option>
                            <option value="upload">Upload Audio File</option>
                            <option value="url">Audio URL</option>
                        </select>
                    </div>
                    <div id="sample-generate-group">
                        <div class="form-group">
                            <label for="sample-text">Sample Text</label>
                            <textarea id="sample-text" name="sample_text" class="form-control" rows="2">Hello, I'm a voice assistant. How can I help you today?</textarea>
                        </div>
                        <button type="button" id="generate-sample-btn" class="button secondary-button">Generate Sample</button>
                    </div>
                    <div id="sample-upload-group" style="display: none;">
                        <div class="form-group">
                            <label for="sample-upload">Upload Audio Sample</label>
                            <input type="file" id="sample-upload" name="sample_file" class="form-control-file" accept="audio/*">
                        </div>
                    </div>
                    <div id="sample-url-group" style="display: none;">
                        <div class="form-group">
                            <label for="sample-url">Sample Audio URL</label>
                            <input type="url" id="sample-url" name="sample_url" class="form-control" placeholder="https://example.com/audio.mp3">
                        </div>
                    </div>
                    <div id="sample-player-container" style="display: none;">
                        <h4>Preview</h4>
                        <audio id="sample-player" controls></audio>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>Advanced Settings</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="voice-speaker-id">Speaker ID</label>
                            <input type="number" id="voice-speaker-id" name="speaker_id" class="form-control" min="1" required>
                            <small class="form-text">Unique ID used by the model to identify this voice.</small>
                        </div>
                        <div class="form-group">
                            <div class="checkbox-control">
                                <input type="checkbox" id="voice-featured" name="featured">
                                <label for="voice-featured">Featured Voice</label>
                            </div>
                            <small class="form-text">Featured voices appear at the top of selection lists.</small>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button id="cancel-edit-btn" class="button secondary-button">Cancel</button>
            <button id="save-voice-btn" class="button primary-button">Save Voice</button>
        </div>
    </div>
</div>

<!-- Test Voice Modal -->
<div id="test-voice-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Test Voice: <span id="test-voice-name"></span></h2>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <div class="test-voice-container">
                <div class="form-section">
                    <div class="form-group">
                        <label for="test-text">Text to Speak</label>
                        <textarea id="test-text" name="text" rows="5" class="form-control" placeholder="Enter text to generate...">Hello, this is a test of the EchoForge voice generation system. I hope you're having a wonderful day!</textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="test-device">Device</label>
                            <select id="test-device" name="device" class="form-control">
                                <option value="auto">Auto (Use GPU if available)</option>
                                <option value="cuda">CUDA (GPU Only)</option>
                                <option value="cpu">CPU Only</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="test-temperature">Temperature: <span id="temperature-value">0.7</span></label>
                            <input type="range" id="test-temperature" name="temperature" min="0.1" max="1.0" step="0.05" value="0.7" class="form-control-range">
                            <small class="form-text">Higher values increase creativity but may reduce stability.</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="test-top-k">Top-K: <span id="top-k-value">50</span></label>
                            <input type="range" id="test-top-k" name="top_k" min="1" max="100" step="1" value="50" class="form-control-range">
                            <small class="form-text">Controls diversity of generated audio.</small>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button id="generate-test-btn" class="button primary-button">Generate Audio</button>
                </div>
                
                <div id="test-results" class="test-results" style="display: none;">
                    <div class="results-header">
                        <h3>Test Results</h3>
                    </div>
                    
                    <div id="test-status" class="test-status">
                        <div class="status-message">Processing...</div>
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="test-audio-section" class="test-audio" style="display: none;">
                        <audio id="test-audio-player" controls></audio>
                        <div class="audio-controls">
                            <button id="test-download-btn" class="button secondary-button">Download</button>
                            <button id="test-copy-link-btn" class="button secondary-button">Copy Link</button>
                        </div>
                    </div>
                    
                    <div id="test-error" class="test-error" style="display: none;">
                        <div class="error-message"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button id="close-test-btn" class="button secondary-button">Close</button>
        </div>
    </div>
</div>

<!-- Delete Voice Confirmation Modal -->
<div id="delete-voice-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Delete Voice</h2>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <div class="warning-message">
                <div class="warning-icon">⚠️</div>
                <div class="warning-text">
                    <p><strong>Warning:</strong> Are you sure you want to delete the voice "<span id="delete-voice-name"></span>"?</p>
                    <p>This action cannot be undone. This will permanently remove the voice and all associated data.</p>
                </div>
            </div>
            <div class="confirmation-checkbox">
                <div class="checkbox-control">
                    <input type="checkbox" id="delete-confirmation" name="delete_confirmation">
                    <label for="delete-confirmation">I understand that this action cannot be undone</label>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button id="cancel-delete-btn" class="button secondary-button">Cancel</button>
            <button id="confirm-delete-btn" class="button danger-button" disabled>Delete Voice</button>
        </div>
    </div>
</div>

<!-- Voice generation form section -->
<div class="card mt-4">
    <div class="card-header">
        <h5><i class="fas fa-microphone"></i> Generate Voice</h5>
        <p class="text-muted mb-0">Generate a new voice sample using the selected voice</p>
    </div>
    <div class="card-body">
        <form id="voice-generation-form">
            <div class="form-group">
                <label for="voice-text">Text to Speak:</label>
                <textarea id="voice-text" class="form-control" rows="3" 
                    placeholder="Enter text to convert to speech..."></textarea>
            </div>
            
            <div class="form-group">
                <label for="voice-speaker">Speaker Voice:</label>
                <select id="voice-speaker" class="form-control">
                    <option value="1">Default Voice (ID: 1)</option>
                    <option value="2">Female Voice (ID: 2)</option>
                    <option value="3">Male Voice (ID: 3)</option>
                    <option value="4">Child Voice (ID: 4)</option>
                </select>
            </div>
            
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="voice-temperature">Temperature:</label>
                    <input type="range" id="voice-temperature" class="form-control-range" 
                        min="0.1" max="1.0" step="0.05" value="0.7">
                    <span id="temperature-value">0.7</span>
                    <small class="text-muted d-block">Higher values increase creativity but may reduce stability.</small>
                </div>
                
                <div class="form-group col-md-6">
                    <label for="voice-device">Device:</label>
                    <select id="voice-device" class="form-control">
                        <option value="cpu">CPU only</option>
                        <option value="auto">Auto (Use GPU if available)</option>
                        <option value="cuda">CUDA (GPU)</option>
                    </select>
                    <small class="text-muted">Start with CPU for the most reliable results</small>
                </div>
            </div>
            
            <button type="submit" id="generate-voice-btn" class="btn btn-primary">
                <i class="fas fa-microphone"></i> Generate Voice
            </button>
        </form>
        
        <div id="generation-status" class="mt-3" style="display: none;">
            <div class="progress">
                <div id="generation-progress" class="progress-bar" role="progressbar" 
                    style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
            </div>
            <p id="generation-message" class="text-info mt-2"></p>
        </div>
        
        <div id="generation-result" class="mt-3" style="display: none;">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5>Voice Generated Successfully</h5>
                </div>
                <div class="card-body">
                    <div id="audio-player-container">
                        <audio id="generated-audio" controls class="w-100"></audio>
                    </div>
                    <div class="mt-2">
                        <a id="download-link" href="#" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-download"></i> Download Audio
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="generation-error" class="mt-3 alert alert-danger" style="display: none;">
            <h5><i class="fas fa-exclamation-triangle"></i> Error</h5>
            <p id="error-message"></p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Range slider value display
        const temperatureSlider = document.getElementById('voice-temperature');
        const temperatureValue = document.getElementById('temperature-value');
        temperatureSlider.addEventListener('input', function() {
            temperatureValue.textContent = this.value;
        });
        
        const topKSlider = document.getElementById('voice-top-k');
        const topKValue = document.getElementById('top-k-value');
        topKSlider.addEventListener('input', function() {
            topKValue.textContent = this.value;
        });
        
        // Voice generation form submission
        const generationForm = document.getElementById('voice-generation-form');
        generationForm.addEventListener('submit', function(event) {
            event.preventDefault();
            
            // Get form values
            const text = document.getElementById('voice-text').value.trim();
            const speakerId = parseInt(document.getElementById('voice-speaker').value);
            const temperature = parseFloat(document.getElementById('voice-temperature').value);
            const device = document.getElementById('voice-device').value;
            
            // Validate form
            if (!text) {
                showError('Please enter text to convert to speech.');
                return;
            }
            
            // Show generation status
            showGenerationStatus('Starting voice generation...');
            
            // Disable form submission while processing
            document.getElementById('generate-voice-btn').disabled = true;
            
            // Clear previous error or result display
            document.getElementById('generation-error').style.display = 'none';
            document.getElementById('generation-result').style.display = 'none';
            
            // Call the API to generate voice
            console.log(`Generating voice: speakerId=${speakerId}, temperature=${temperature}, device=${device}`);
            
            fetch('/api/admin/generate-voice', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    text: text,
                    speaker_id: speakerId,
                    temperature: temperature,
                    top_k: 50, // Using default value
                    style: "natural", // Using default value
                    device: device
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.detail || 'Error starting voice generation');
                    });
                }
                return response.json();
            })
            .then(data => {
                // Task started successfully, poll for status
                updateGenerationStatus('Voice generation started', 10);
                pollTaskStatus(data.task_id);
            })
            .catch(error => {
                // Show error and re-enable button
                showError(error.message);
                document.getElementById('generate-voice-btn').disabled = false;
            });
        });
        
        // Function to poll task status
        function pollTaskStatus(taskId) {
            const pollInterval = setInterval(() => {
                fetch(`/api/admin/tasks/${taskId}`)
                    .then(response => {
                        if (!response.ok) {
                            clearInterval(pollInterval);
                            throw new Error('Error fetching task status');
                        }
                        return response.json();
                    })
                    .then(data => {
                        switch (data.status) {
                            case 'pending':
                                updateGenerationStatus('Task pending...', 25);
                                break;
                            case 'processing':
                                updateGenerationStatus('Processing voice...', 50);
                                break;
                            case 'completed':
                                clearInterval(pollInterval);
                                updateGenerationStatus('Voice generated successfully!', 100);
                                showGenerationResult(data.result);
                                document.getElementById('generate-voice-btn').disabled = false;
                                break;
                            case 'failed':
                                clearInterval(pollInterval);
                                updateGenerationStatus('Voice generation failed', 100);
                                showError(data.error || 'Failed to generate voice');
                                document.getElementById('generate-voice-btn').disabled = false;
                                break;
                            default:
                                updateGenerationStatus(`Unknown status: ${data.status}`, 50);
                        }
                    })
                    .catch(error => {
                        clearInterval(pollInterval);
                        showError(error.message);
                        document.getElementById('generate-voice-btn').disabled = false;
                    });
            }, 2000); // Poll every 2 seconds
        }
        
        // Function to update generation status
        function updateGenerationStatus(message, progress = 0) {
            const statusDiv = document.getElementById('generation-status');
            const progressBar = document.getElementById('generation-progress');
            const messageElement = document.getElementById('generation-message');
            
            statusDiv.style.display = 'block';
            progressBar.style.width = `${progress}%`;
            progressBar.setAttribute('aria-valuenow', progress);
            progressBar.textContent = `${progress}%`;
            messageElement.textContent = message;
            
            document.getElementById('generation-error').style.display = 'none';
            document.getElementById('generation-result').style.display = 'none';
        }
        
        // Function to show generation status
        function showGenerationStatus(message) {
            updateGenerationStatus(message, 0);
        }
        
        // Function to show generation result
        function showGenerationResult(result) {
            if (!result || !result.file_url) {
                showError('Voice generation completed but no audio file was returned');
                return;
            }
            
            const resultDiv = document.getElementById('generation-result');
            const audioPlayer = document.getElementById('generated-audio');
            const downloadLink = document.getElementById('download-link');
            
            // Set audio source - Use the file_url from the result
            audioPlayer.src = result.file_url;
            
            // Set download link - Use the file_url and filename from the result
            downloadLink.href = result.file_url;
            
            // Extract filename from URL for the download attribute
            const filename = result.file_url.split('/').pop();
            downloadLink.download = filename;
            
            // Show result container
            resultDiv.style.display = 'block';
            
            // Hide status container
            document.getElementById('generation-status').style.display = 'none';
            
            // Log success for debugging
            console.log("Audio generated successfully:", result);
        }
        
        // Function to show error
        function showError(errorMessage) {
            const errorDiv = document.getElementById('generation-error');
            const errorMessageElement = document.getElementById('error-message');
            
            errorDiv.style.display = 'block';
            errorMessageElement.textContent = errorMessage;
            
            document.getElementById('generation-status').style.display = 'none';
            document.getElementById('generation-result').style.display = 'none';
            
            // Log error for debugging
            console.error("Voice generation error:", errorMessage);
        }
    });
</script>
{% endblock %} 